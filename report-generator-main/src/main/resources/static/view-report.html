<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Report - GMR</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<!-- Navigation -->
<nav class="navbar no-print">
    <div class="nav-container">
        <div class="logo">ü´Ä GMR</div>
        <div class="nav-right">
            <span class="doctor-badge" id="doctorName">üë®‚Äç‚öïÔ∏è Loading...</span>
            <a href="/report.html" class="nav-link">‚Üê Back to History</a>
            <button onclick="window.print()" class="btn btn-secondary-small">üñ®Ô∏è Print</button>
            <a href="/login.html" onclick="logout()" class="btn btn-secondary-small">Logout</a>
        </div>
    </div>
</nav>

<div class="report-wrapper">
    <!-- Loading State -->
    <div id="loadingState" class="loading-state">
        <div class="loading-spinner">‚è≥</div>
        <h2>Generating AI Report...</h2>
        <p>Please wait while we analyze the observation data...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="error-state" style="display: none;">
        <div style="font-size: 64px;">‚ùå</div>
        <h2>Error Loading Report</h2>
        <p id="errorMessage">Unable to load the report. Please try again.</p>
        <button class="btn btn-primary" onclick="window.location.href='/report.html'">
            ‚Üê Back to Reports
        </button>
    </div>

    <!-- Report Content -->
    <div id="reportContent" class="report-container" style="display: none;">
        <!-- Header -->
        <div class="report-header">
            <h1>ü´Ä CARDIAC ASSESSMENT REPORT</h1>
            <p id="reportId" style="color: #8d99ae; margin: 5px 0;">Report ID: #...</p>
            <p id="reportDate" style="color: #8d99ae; margin: 5px 0;">Date: ...</p>
        </div>

        <!-- Patient & Doctor Info -->
        <div class="report-meta">
            <div class="meta-item">
                <span class="meta-label">Patient Name</span>
                <span class="meta-value" id="patientName">Loading...</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Age</span>
                <span class="meta-value" id="patientAge">...</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Gender</span>
                <span class="meta-value" id="patientGender">...</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Doctor</span>
                <span class="meta-value" id="doctorNameReport">Loading...</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Risk Level</span>
                <span id="riskBadge" class="risk-badge">...</span>
            </div>
        </div>

        <!-- Vital Signs -->
        <div class="report-section">
            <h2>üíì Vital Signs</h2>
            <div class="vital-signs-grid" id="vitalSignsGrid">
                <div class="vital-card">
                    <h4>Heart Rate</h4>
                    <p>Loading...</p>
                </div>
            </div>
        </div>

        <!-- Symptoms -->
        <div class="report-section">
            <h2>üìù Symptoms & Clinical Notes</h2>
            <div class="symptoms-box" id="symptomsText">
                Loading symptoms...
            </div>
        </div>

        <!-- AI Generated Report -->
        <div class="report-section">
            <h2>ü§ñ AI-Generated Medical Analysis</h2>
            <div class="ai-report-content" id="aiReportText">
                Generating comprehensive analysis...
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons no-print">
            <button onclick="window.print()" class="btn btn-secondary">
                üñ®Ô∏è Print Report
            </button>
            <button onclick="window.location.href='/report.html'" class="btn btn-secondary">
                ‚Üê Back to History
            </button>
            <button onclick="window.location.href='/new-report.html'" class="btn btn-primary">
                ‚ûï New Assessment
            </button>
        </div>
    </div>
</div>

<script>
    // Get observationId from URL
    const urlParams = new URLSearchParams(window.location.search);
    const observationId = urlParams.get('observationId');

    console.log('Loading report for observation ID:', observationId);

    async function loadReport() {
        if (!observationId) {
            showError('No observation ID provided in URL');
            return;
        }

        try {
            console.log('Fetching report from:', `http://localhost:8080/api/reports/generate/${observationId}`);

            const response = await fetch(`http://localhost:8080/api/reports/generate/${observationId}`, {
                credentials: 'include'
            });

            console.log('Response status:', response.status);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const report = await response.json();
            console.log('Report data received:', report);

            displayReport(report);

        } catch (error) {
            console.error('Error loading report:', error);
            showError(`Failed to load report: ${error.message}`);
        }
    }

    function displayReport(report) {
        console.log('Displaying report...');

        // Hide loading, show content
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('reportContent').style.display = 'block';

        // Set basic info
        document.getElementById('reportId').textContent = `Report ID: #${report.id || observationId}`;

        const reportDate = report.generatedAt || report.observation?.observationDate || new Date();
        document.getElementById('reportDate').textContent = `Date: ${formatDate(reportDate)}`;

        // Patient info
        const observation = report.observation;
        if (!observation) {
            showError('No observation data in report');
            return;
        }

        const patient = observation.patient;
        const doctor = observation.doctor;

        document.getElementById('patientName').textContent = `${patient.firstName} ${patient.lastName}`;
        document.getElementById('patientAge').textContent = `${calculateAge(patient.birthDate)} years`;
        document.getElementById('patientGender').textContent = patient.gender;

        // Doctor info
        const doctorDisplay = doctor.fullName || `Dr. ${doctor.code}`;
        document.getElementById('doctorName').textContent = `üë®‚Äç‚öïÔ∏è ${doctorDisplay}`;
        document.getElementById('doctorNameReport').textContent = doctorDisplay;

        // Risk level
        const riskBadge = document.getElementById('riskBadge');
        const riskLevel = (report.riskLevel || 'UNKNOWN').toLowerCase();
        riskBadge.textContent = riskLevel.toUpperCase();
        riskBadge.className = 'risk-badge risk-' + riskLevel;

        // Vital signs
        const vitalSigns = observation.vitalSigns;
        const vitalSignsGrid = document.getElementById('vitalSignsGrid');

        if (vitalSigns && typeof vitalSigns === 'object') {
            vitalSignsGrid.innerHTML = Object.entries(vitalSigns).map(([key, value]) => {
                const label = formatVitalSignLabel(key);
                return `
                    <div class="vital-card">
                        <h4>${label}</h4>
                        <p>${value}</p>
                    </div>
                `;
            }).join('');
        }

        // Symptoms
        document.getElementById('symptomsText').textContent = observation.symptomsDescription || 'No symptoms recorded';

        // AI Generated Report
        const aiContent = report.reportContent || 'No AI report content available';
        document.getElementById('aiReportText').textContent = aiContent;

        console.log('Report displayed successfully!');
    }

    function formatVitalSignLabel(key) {
        const labels = {
            'heartRate': 'Heart Rate (bpm)',
            'systolicBloodPressure': 'Systolic BP (mmHg)',
            'diastolicBloodPressure': 'Diastolic BP (mmHg)',
            'bodyTemperature': 'Temperature (¬∞C)',
            'oxygenSaturation': 'Oxygen Saturation (%)',
            'respiratoryRate': 'Respiratory Rate (/min)'
        };
        return labels[key] || key.replace(/([A-Z])/g, ' $1').trim();
    }

    function calculateAge(birthDate) {
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        return age;
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function showError(message) {
        console.error('Showing error:', message);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('reportContent').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
    }

    function logout() {
        localStorage.clear();
        window.location.href = '/login.html';
    }

    // Load report on page load
    window.addEventListener('DOMContentLoaded', loadReport);
</script>
</body>
</html>