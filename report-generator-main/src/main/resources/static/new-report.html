<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Report</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">ü´Ä GMR</div>
            <div class="nav-right">
                <a href="dashboard.html" class="nav-link">‚Üê Dashboard</a>
                <a href="index.html" onclick="logout()" class="btn btn-secondary-small">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Form Section -->
    <section class="form-section">
        <div class="form-container">
            <div class="form-header">
                <h1>üìã New Cardiac Assessment</h1>

                <div class="doctor-info" id="doctorInfoBadge">
                    <span>üë®‚Äç‚öïÔ∏è Loading...</span>
                </div>
            </div>

            <form id="patientForm">

                <!-- PATIENT INFORMATION -->
                <div class="form-section-title">
                    <h2>üë§ Patient Information</h2>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="patientName">Full Name *</label>
                        <input type="text" id="patientName" placeholder="John Doe" required>
                    </div>
                    <div class="form-group">
                        <label for="age">Age *</label>
                        <input type="number" id="age" placeholder="45" min="1" max="120" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="gender">Gender *</label>
                        <select id="gender" required>
                            <option value="">Select...</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="weight">Weight (kg)</label>
                        <input type="number" id="weight" placeholder="75" min="20" max="300" step="0.1">
                    </div>
                </div>

                <!-- CARDIAC PARAMETERS -->
                <div class="form-section-title">
                    <h2>üíì Cardiac Parameters</h2>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="heartRate">Heart Rate (bpm) *</label>
                        <input type="number" id="heartRate" placeholder="75" min="30" max="220" required>
                        <small class="hint">Normal: 60-100 bpm</small>
                    </div>
                    <div class="form-group">
                        <label for="systolicBP">Systolic BP (mmHg) *</label>
                        <input type="number" id="systolicBP" placeholder="120" min="70" max="250" required>
                        <small class="hint">Normal: 90-120 mmHg</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="diastolicBP">Diastolic BP (mmHg) *</label>
                        <input type="number" id="diastolicBP" placeholder="80" min="40" max="150" required>
                        <small class="hint">Normal: 60-80 mmHg</small>
                    </div>
                    <div class="form-group">
                        <label for="cholesterol">Total Cholesterol (mg/dL)</label>
                        <input type="number" id="cholesterol" placeholder="180" min="100" max="400">
                        <small class="hint">Normal: &lt;200 mg/dL</small>
                    </div>
                </div>



                <!-- CLINICAL NOTES -->
                <div class="form-section-title">
                    <h2>üìù Clinical Notes</h2>
                </div>

                <div class="form-group">
                    <label for="symptoms">Symptoms</label>
                    <textarea id="symptoms" rows="3" placeholder="Patient complaints, symptoms observed..."></textarea>
                </div>

                <div class="form-group">
                    <label for="medicalHistory">Medical History</label>
                    <textarea id="medicalHistory" rows="3" placeholder="Previous conditions, surgeries, family history..."></textarea>
                </div>

                <!-- SUBMIT BUTTONS -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        üîÑ Reset Form
                    </button>
                    <button type="submit" class="btn btn-primary" onclick="window.location.href='report.html'">
                        üî¨ Generate Report
                    </button>
                </div>

            </form>
        </div>
    </section>

    <script>
        // Verificare autentificare prin Cookie
        async function initNewReport() {
            try {
                const response = await fetch('http://localhost:8080/api/reports/new', {
                    credentials: 'include' // trimite cookie-ul automat
                });

                if (response.status === 403 || response.status === 401) {
                    console.warn('Nu e»ôti autentificat, redirectƒÉm...');
                    window.location.href = '/login.html';
                    return;
                }

                const data = await response.json();
                console.log('New report data:', data);

                // SetƒÉm numele doctorului
                if (data && data.doctorCode) {
                    document.getElementById('doctorInfoBadge').innerHTML =
                        '<span>üë®‚Äç‚öïÔ∏è Dr. ' + data.doctorCode + '</span>';
                }
            } catch (err) {
                console.error('Eroare:', err);
                window.location.href = '/login.html';
            }
        }

        // Submit formular
        document.getElementById('patientForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                patientName: document.getElementById('patientName').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                weight: document.getElementById('weight').value,
                heartRate: document.getElementById('heartRate').value,
                systolicBP: document.getElementById('systolicBP').value,
                diastolicBP: document.getElementById('diastolicBP').value,
                cholesterol: document.getElementById('cholesterol').value,
                symptoms: document.getElementById('symptoms').value,
                medicalHistory: document.getElementById('medicalHistory').value
            };

            // SalvƒÉm datele pentru report.html
            localStorage.setItem('currentReport', JSON.stringify(formData));

            try {
                const response = await fetch('http://localhost:8080/api/reports/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    window.location.href = '/report.html';
                } else {
                    alert('‚ùå Failed to create report');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error creating report');
            }
        });

        function resetForm() {
            document.getElementById('patientForm').reset();
        }
function logout() {
        localStorage.clear();
        window.location.href = '/login.html';
    }

    // Ini»õializare
    initNewReport();
    </script>
</body>
</html>