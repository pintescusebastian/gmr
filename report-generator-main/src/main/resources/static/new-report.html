<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Report - GMR</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<!-- Navigation -->
<nav class="navbar">
    <div class="nav-container">
        <div class="logo">ü´Ä GMR</div>
        <div class="nav-right">
            <span class="doctor-badge" id="doctorName">üë®‚Äç‚öïÔ∏è Loading...</span>
            <a href="/dashboard.html" class="nav-link">‚Üê Dashboard</a>
            <a href="/login.html" onclick="logout()" class="btn btn-secondary-small">Logout</a>
        </div>
    </div>
</nav>

<!-- Form Section -->
<section class="form-section">
    <div class="form-container">
        <div class="form-header">
            <h1>üìã New Cardiac Assessment</h1>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <span>1Ô∏è‚É£</span>
                <span>Select Patient</span>
            </div>
            <div class="step" id="step2">
                <span>2Ô∏è‚É£</span>
                <span>Medical Observation</span>
            </div>
            <div class="step" id="step3">
                <span>3Ô∏è‚É£</span>
                <span>Generate Report</span>
            </div>
        </div>

        <!-- STEP 1: Patient Search/Selection -->
        <div class="patient-search-section" id="patientSearchSection">
            <h2>üë§ Find or Create Patient</h2>

            <div class="search-container">
                <div class="search-input-wrapper">
                    <span class="search-icon">üîç</span>
                    <input
                            type="text"
                            id="patientSearch"
                            class="search-input"
                            placeholder="Search by name or CNP..."
                    >
                </div>
                <button class="btn btn-secondary" onclick="showNewPatientForm()">
                    ‚ûï New Patient
                </button>
            </div>

            <div class="patients-list" id="patientsList">
                <p style="text-align: center; color: #8d99ae;">
                    Start typing to search for patients...
                </p>
            </div>
        </div>

        <!-- New Patient Form (hidden initially) -->
        <div class="new-patient-form" id="newPatientForm">
            <h2>‚ûï Register New Patient</h2>

            <form id="createPatientForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">First Name *</label>
                        <input type="text" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name *</label>
                        <input type="text" id="lastName" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cnp">CNP *</label>
                        <input type="text" id="cnp" pattern="\d{13}" maxlength="13" required>
                        <small class="hint">13 digits</small>
                    </div>
                    <div class="form-group">
                        <label for="birthDate">Birth Date *</label>
                        <input type="date" id="birthDate" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="gender">Gender *</label>
                        <select id="gender" required>
                            <option value="">Select...</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="smoker">Smoking Status *</label>
                        <select id="smoker" required>
                            <option value="">Select...</option>
                            <option value="true">Smoker</option>
                            <option value="false">Non-smoker</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="cholesterolStatus">Cholesterol Status</label>
                    <select id="cholesterolStatus">
                        <option value="">Select...</option>
                        <option value="Normal">Normal (&lt;200 mg/dL)</option>
                        <option value="Borderline">Borderline High (200-239 mg/dL)</option>
                        <option value="High">High (‚â•240 mg/dL)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="medicalHistory">Medical History</label>
                    <textarea id="medicalHistory" rows="3" placeholder="Previous conditions, surgeries, family history..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideNewPatientForm()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        ‚úì Create Patient
                    </button>
                </div>
            </form>
        </div>

        <!-- Selected Patient Badge -->
        <div class="selected-patient-badge" id="selectedPatientBadge">
            <div>
                <strong>Selected Patient:</strong>
                <span id="selectedPatientInfo"></span>
            </div>
            <button class="btn btn-secondary-small" onclick="changePatient()">
                Change Patient
            </button>
        </div>

        <!-- STEP 2: Observation Form -->
        <form id="observationForm" class="observation-form">
            <div class="form-section-title">
                <h2>üíì Cardiac Parameters</h2>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="heartRate">Heart Rate (bpm) *</label>
                    <input type="number" id="heartRate" placeholder="75" min="30" max="220" required>
                    <small class="hint">Normal: 60-100 bpm</small>
                </div>
                <div class="form-group">
                    <label for="systolicBP">Systolic BP (mmHg) *</label>
                    <input type="number" id="systolicBP" placeholder="120" min="70" max="250" required>
                    <small class="hint">Normal: 90-120 mmHg</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="diastolicBP">Diastolic BP (mmHg) *</label>
                    <input type="number" id="diastolicBP" placeholder="80" min="40" max="150" required>
                    <small class="hint">Normal: 60-80 mmHg</small>
                </div>
                <div class="form-group">
                    <label for="temperature">Temperature (¬∞C)</label>
                    <input type="number" id="temperature" placeholder="36.6" min="35" max="42" step="0.1">
                    <small class="hint">Normal: 36.5-37.5 ¬∞C</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="oxygenSaturation">Oxygen Saturation (%)</label>
                    <input type="number" id="oxygenSaturation" placeholder="98" min="70" max="100">
                    <small class="hint">Normal: 95-100%</small>
                </div>
                <div class="form-group">
                    <label for="respiratoryRate">Respiratory Rate (breaths/min)</label>
                    <input type="number" id="respiratoryRate" placeholder="16" min="8" max="40">
                    <small class="hint">Normal: 12-20/min</small>
                </div>
            </div>

            <div class="form-section-title">
                <h2>üìù Clinical Notes</h2>
            </div>

            <div class="form-group">
                <label for="symptoms">Symptoms *</label>
                <textarea id="symptoms" rows="3" placeholder="Patient complaints, symptoms observed..." required></textarea>
            </div>

            <div class="form-group">
                <label for="diagnosis">Diagnosis/Impression</label>
                <textarea id="diagnosis" rows="3" placeholder="Preliminary diagnosis or clinical impression..."></textarea>
            </div>

            <div class="form-group">
                <label for="additionalNotes">Additional Notes</label>
                <textarea id="additionalNotes" rows="3" placeholder="Any other relevant information..."></textarea>
            </div>

            <!-- Submit Buttons -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="goBackToPatientSelection()">
                    ‚Üê Back to Patient Selection
                </button>
                <button type="submit" class="btn btn-primary">
                    üî¨ Generate AI Report
                </button>
            </div>
        </form>
    </div>
</section>

<script>
    let selectedPatient = null;
    let currentDoctorCode = null;

    // Verificare autentificare
    async function initNewReport() {
        try {
            const response = await fetch('http://localhost:8080/api/reports/new', {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                console.log('New report data:', data);

                if (data && data.doctorCode) {
                    document.getElementById('doctorName').textContent = `üë®‚Äç‚öïÔ∏è Dr. ${data.doctorCode}`;
                    currentDoctorCode = data.doctorCode;
                }
            } else {
                console.warn('Response not OK:', response.status);
            }
        } catch (err) {
            console.error('Eroare:', err);
        }
    }

    // Search patients
    let searchTimeout;
    document.getElementById('patientSearch').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const searchTerm = e.target.value.trim();

        if (searchTerm.length < 2) {
            document.getElementById('patientsList').innerHTML =
                '<p style="text-align: center; color: #8d99ae;">Start typing to search for patients...</p>';
            return;
        }

        searchTimeout = setTimeout(() => searchPatients(searchTerm), 300);
    });

    async function searchPatients(searchTerm) {
        try {
            const response = await fetch(`http://localhost:8080/api/patients?search=${encodeURIComponent(searchTerm)}`, {
                credentials: 'include'
            });

            if (response.ok) {
                const patients = await response.json();
                displayPatients(patients);
            } else {
                console.error('Error searching patients');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function displayPatients(patients) {
        const patientsList = document.getElementById('patientsList');

        if (patients.length === 0) {
            patientsList.innerHTML = '<p style="text-align: center; color: #8d99ae;">No patients found. Try a different search or create a new patient.</p>';
            return;
        }

        patientsList.innerHTML = patients.map(patient => {
            const fullName = `${patient.firstName} ${patient.lastName}`;
            const age = calculateAge(patient.birthDate);
            return `
                <div class="patient-card" onclick='selectPatient(${JSON.stringify(patient)})'>
                    <div class="patient-info">
                        <div class="patient-details">
                            <h4>${fullName}</h4>
                            <p>CNP: ${patient.cnp} | Age: ${age} | ${patient.gender}</p>
                            ${patient.smoker ? '<p>üö¨ Smoker</p>' : '<p>üö≠ Non-smoker</p>'}
                        </div>
                        <div>‚Üí</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function calculateAge(birthDate) {
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        return age;
    }

    function selectPatient(patient) {
        selectedPatient = patient;
        const fullName = `${patient.firstName} ${patient.lastName}`;

        // Update badge
        document.getElementById('selectedPatientInfo').textContent = `${fullName} (CNP: ${patient.cnp})`;
        document.getElementById('selectedPatientBadge').classList.add('show');

        // Hide search section, show observation form
        document.getElementById('patientSearchSection').style.display = 'none';
        document.getElementById('observationForm').style.display = 'block';

        // Update steps
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step1').classList.add('completed');
        document.getElementById('step2').classList.add('active');
    }

    function showNewPatientForm() {
        document.getElementById('patientSearchSection').style.display = 'none';
        document.getElementById('newPatientForm').style.display = 'block';
    }

    function hideNewPatientForm() {
        document.getElementById('newPatientForm').style.display = 'none';
        document.getElementById('patientSearchSection').style.display = 'block';
    }

    // Create new patient
    document.getElementById('createPatientForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const patientData = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            cnp: document.getElementById('cnp').value,
            birthDate: document.getElementById('birthDate').value,
            gender: document.getElementById('gender').value,
            smoker: document.getElementById('smoker').value === 'true',
            cholesterolStatus: document.getElementById('cholesterolStatus').value || null,
            medicalHistory: document.getElementById('medicalHistory').value || null
        };

        try {
            const response = await fetch('http://localhost:8080/api/patients', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(patientData)
            });

            if (response.status === 201) {
                const newPatient = await response.json();
                alert('‚úÖ Patient created successfully!');

                // Select the newly created patient
                selectPatient(newPatient);
                hideNewPatientForm();
            } else if (response.status === 409) {
                alert('‚ùå A patient with this CNP already exists!');
            } else {
                alert('‚ùå Error creating patient');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error creating patient');
        }
    });

    function changePatient() {
        selectedPatient = null;
        document.getElementById('selectedPatientBadge').classList.remove('show');
        document.getElementById('patientSearchSection').style.display = 'block';
        document.getElementById('observationForm').style.display = 'none';

        // Update steps
        document.getElementById('step1').classList.remove('completed');
        document.getElementById('step1').classList.add('active');
        document.getElementById('step2').classList.remove('active');
    }

    function goBackToPatientSelection() {
        changePatient();
    }

    // Submit observation
    document.getElementById('observationForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!selectedPatient) {
            alert('‚ùå Please select a patient first!');
            return;
        }

        // Trebuie sƒÉ gƒÉsim doctorId - presupunem DR1001 = id 1
        const doctorId = 1;

        // Construim vitalSigns ca Map<String, String>
        const vitalSigns = {
            heartRate: document.getElementById('heartRate').value,
            systolicBloodPressure: document.getElementById('systolicBP').value,
            diastolicBloodPressure: document.getElementById('diastolicBP').value
        };

        // AdƒÉugƒÉm valorile op»õionale doar dacƒÉ existƒÉ
        const temp = document.getElementById('temperature').value;
        if (temp) vitalSigns.bodyTemperature = temp;

        const oxygen = document.getElementById('oxygenSaturation').value;
        if (oxygen) vitalSigns.oxygenSaturation = oxygen;

        const respRate = document.getElementById('respiratoryRate').value;
        if (respRate) vitalSigns.respiratoryRate = respRate;

        // Construim symptomsDescription combin√¢nd toate notele clinice
        let symptomsDescription = document.getElementById('symptoms').value;

        const diagnosis = document.getElementById('diagnosis').value;
        if (diagnosis) {
            symptomsDescription += '\n\nDiagnosis: ' + diagnosis;
        }

        const additionalNotes = document.getElementById('additionalNotes').value;
        if (additionalNotes) {
            symptomsDescription += '\n\nAdditional Notes: ' + additionalNotes;
        }

        const observationData = {
            patientId: selectedPatient.id,
            doctorId: doctorId,
            symptomsDescription: symptomsDescription,
            vitalSigns: vitalSigns
        };

        console.log('Sending observation:', observationData);

        try {
            const response = await fetch('http://localhost:8080/api/reports/observation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(observationData)
            });

            if (response.status === 201) {
                const observation = await response.json();
                alert('‚úÖ Observation recorded! Generating AI report...');

                // Redirect to report generation/display
                window.location.href = `/report.html?observationId=${observation.id}`;
            } else {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                alert('‚ùå Error recording observation');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error recording observation');
        }
    });

    function logout() {
        localStorage.clear();
        window.location.href = '/login.html';
    }

    // Ini»õializare
    initNewReport();
</script>
</body>
</html>